<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Currency Converter (USD / KHR / RMB)</title>

<!-- Google Analytics (GA4) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3BT4GY2B36"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-3BT4GY2B36');
</script>

<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#ffffff">

<style>
  body { font-family: system-ui, Arial; margin:20px; }
  .card { max-width:640px; margin:auto; padding:20px; border:1px solid #eee; border-radius:12px; }
  h1 { font-size:20px; margin:0 0 6px; }
  .meta { color:#666; font-size:13px; margin-bottom:12px; }
  .hint { font-size:13px; margin:10px 0 10px; color:#111; }
  .lang-switch { text-align:right; margin-bottom:10px; font-size:14px; }
  .lang-switch span { cursor:pointer; }

  .grid { display:grid; grid-template-columns: 1fr 1fr auto; gap:10px; align-items:end; }
  label { font-size:12px; color:#555; display:block; margin-bottom:6px; }
  select, input { width:100%; padding:10px; font-size:16px; }
  button { padding:10px 12px; cursor:pointer; }

  .mini { padding:8px 10px; font-size:14px; border:1px solid #ddd; background:#fafafa; border-radius:10px; }
  .mini:active { transform: translateY(1px); }

  .quick { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
  .resultRow { display:flex; gap:10px; align-items:center; margin-top:14px; }
  .result { flex:1; font-size:18px; }
  .copyBtn { border:1px solid #ddd; background:#fff; border-radius:10px; padding:10px 12px; }
  .copyBtn:disabled { opacity:0.6; cursor:not-allowed; }

  .sub { font-size:11px; color:#777; margin-top:8px; line-height:1.4; }
  .footer { text-align:center; margin-top:26px; font-size:12px; }
</style>
</head>

<body>
<div class="card">

  <div class="lang-switch">
    <span onclick="setLang('en')">EN</span> |
    <span onclick="setLang('km')">ខ្មែរ</span>
  </div>

  <h1 id="title">Currency Converter</h1>
  <div class="meta" id="meta">Loading rates...</div>

  <div class="hint" id="hint">Convert before you exchange money.</div>

  <div class="grid">
    <div>
      <label id="lblFrom">From</label>
      <select id="from">
        <option value="USD">USD</option>
        <option value="KHR">KHR</option>
        <option value="CNY">RMB (CNY)</option>
      </select>
    </div>

    <div>
      <label id="lblTo">To</label>
      <select id="to">
        <option value="KHR">KHR</option>
        <option value="USD">USD</option>
        <option value="CNY">RMB (CNY)</option>
      </select>
    </div>

    <div>
      <button id="swap" class="mini" style="width:100%;">⇄</button>
    </div>
  </div>

  <div style="margin-top:10px;">
    <label id="lblAmount">Amount</label>
    <input id="amount" type="number" inputmode="decimal" placeholder="Enter amount" />
  </div>

  <div class="quick" id="quickButtons"></div>

  <div class="resultRow">
    <div class="result" id="result">Enter amount</div>
    <button id="copy" class="copyBtn" disabled>Copy</button>
  </div>

  <div class="sub">
    Source: Public daily reference rates (for reference only). This tool does not provide financial services.
  </div>

  <div class="footer">
    <a href="/privacy.html">Privacy</a> |
    <a href="/terms.html">Terms</a> |
    <a href="/disclaimer.html">Disclaimer</a>
  </div>

</div>

<script>
  // --------- Quick amounts (auto-switch by From currency) ----------
  const QUICK_AMOUNTS = {
    USD: [50, 75, 120],
    KHR: [50000, 100000, 200000],
    CNY: [100, 300, 500]
  };

  // --------- State ----------
  let currentLang = "en";
  let usd_khr = null; // 1 USD = ? KHR
  let usd_cny = null; // 1 USD = ? CNY
  let lastRateText = ""; // for copy

  const translations = {
    en: {
      title: "Currency Converter",
      hint: "Convert before you exchange money.",
      from: "From",
      to: "To",
      amount: "Amount",
      enter: "Enter amount",
      loading: "Loading rates...",
      tapRetry: "Failed to load rates. Tap to retry.",
      copy: "Copy",
      copied: "Copied"
    },
    km: {
      title: "កម្មវិធីបម្លែងប្រាក់",
      hint: "បម្លែងមុនពេលអ្នកប្តូរប្រាក់។",
      from: "ពី",
      to: "ទៅ",
      amount: "ចំនួន",
      enter: "បញ្ចូលចំនួន",
      loading: "កំពុងផ្ទុកអត្រា...",
      tapRetry: "ផ្ទុកអត្រាមិនបាន។ ចុចដើម្បីសាកល្បងម្តងទៀត។",
      copy: "ចម្លង",
      copied: "បានចម្លង"
    }
  };

  function setLang(lang){
    currentLang = lang;
    document.getElementById("title").innerText = translations[lang].title;
    document.getElementById("hint").innerText = translations[lang].hint;
    document.getElementById("lblFrom").innerText = translations[lang].from;
    document.getElementById("lblTo").innerText = translations[lang].to;
    document.getElementById("lblAmount").innerText = translations[lang].amount;
    document.getElementById("amount").placeholder = translations[lang].enter;
    document.getElementById("copy").innerText = translations[lang].copy;
    calculate(false);
  }

  function setCopyEnabled(enabled){
    const btn = document.getElementById("copy");
    btn.disabled = !enabled;
  }

  function currencyLabel(code){
    return code === "CNY" ? "RMB" : code;
  }

  function renderQuickButtons(){
    const wrap = document.getElementById("quickButtons");
    wrap.innerHTML = "";

    const from = document.getElementById("from").value;
    const arr = QUICK_AMOUNTS[from] || [];
    if (!arr.length) return;

    arr.forEach(v => {
      const b = document.createElement("button");
      b.className = "mini";
      b.type = "button";
      b.textContent = `${v.toLocaleString()} ${currencyLabel(from)}`;
      b.onclick = () => {
        document.getElementById("amount").value = v;
        calculate(true, "quick");
      };
      wrap.appendChild(b);
    });
  }

  function setDefaultAmountByFrom(){
    const from = document.getElementById("from").value;
    const defaults = QUICK_AMOUNTS[from] || [];
    if (defaults.length) {
      document.getElementById("amount").value = defaults[0];
    }
  }

  // Rate for from->to (bridge via USD using usd_khr & usd_cny)
  function getRate(from, to){
    if (from === to) return 1;
    if (usd_khr == null || usd_cny == null) return null;

    // USD -> X
    if (from === "USD" && to === "KHR") return usd_khr;
    if (from === "USD" && to === "CNY") return usd_cny;

    // X -> USD
    if (from === "KHR" && to === "USD") return 1 / usd_khr;
    if (from === "CNY" && to === "USD") return 1 / usd_cny;

    // KHR <-> CNY via USD
    if (from === "KHR" && to === "CNY") return (1 / usd_khr) * usd_cny;
    if (from === "CNY" && to === "KHR") return (1 / usd_cny) * usd_khr;

    return null;
  }

  function formatNumber(n, decimals){
    if (typeof n !== "number" || !isFinite(n)) return "";
    return n.toLocaleString(undefined, { maximumFractionDigits: decimals, minimumFractionDigits: decimals });
  }

  function getResultText(amount, from, to){
    const rate = getRate(from, to);
    if (rate == null || isNaN(amount)) return "";

    const converted = amount * rate;

    const leftDec = (from === "KHR") ? 0 : 2;
    const rightDec = (to === "KHR") ? 0 : 2;

    const left = `${formatNumber(amount, leftDec)} ${currencyLabel(from)}`;
    const right = `${formatNumber(converted, rightDec)} ${currencyLabel(to)}`;
    return `${left} ≈ ${right}`;
  }

  function calculate(track = true, source = "input"){
    const metaEl = document.getElementById("meta");
    const resultEl = document.getElementById("result");

    const from = document.getElementById("from").value;
    const to = document.getElementById("to").value;
    const amount = parseFloat(document.getElementById("amount").value);

    if (usd_khr == null || usd_cny == null){
      resultEl.innerText = translations[currentLang].loading;
      metaEl.innerText = translations[currentLang].loading;
      setCopyEnabled(false);
      return;
    }

    if (isNaN(amount)){
      resultEl.innerText = translations[currentLang].enter;
      setCopyEnabled(false);
      return;
    }

    const text = getResultText(amount, from, to);
    lastRateText = text;
    resultEl.innerText = text || translations[currentLang].enter;
    setCopyEnabled(!!text);

    if (track && typeof gtag === "function") {
      gtag('event', 'calculate', {
        from_currency: from,
        to_currency: to,
        source: source
      });
    }
  }

  async function copyResult(){
    if (!lastRateText) return;

    try {
      await navigator.clipboard.writeText(lastRateText);
      const btn = document.getElementById("copy");
      const old = btn.innerText;
      btn.innerText = translations[currentLang].copied;

      if (typeof gtag === "function") {
        gtag('event', 'copy_result', {
          from_currency: document.getElementById("from").value,
          to_currency: document.getElementById("to").value
        });
      }

      setTimeout(() => btn.innerText = old, 1200);
    } catch (e) {
      try {
        const ta = document.createElement("textarea");
        ta.value = lastRateText;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
      } catch {}
      console.error(e);
    }
  }

  async function loadRates(){
    const metaEl = document.getElementById("meta");
    metaEl.style.cursor = "default";
    metaEl.onclick = null;
    metaEl.innerText = translations[currentLang].loading;

    try {
      // 1) USD->KHR from your existing API
      const controller1 = new AbortController();
      const t1 = setTimeout(() => controller1.abort(), 10000);
      const r1 = await fetch('/api/rate?ts=' + Date.now(), { cache: "no-store", signal: controller1.signal });
      clearTimeout(t1);
      if (!r1.ok) throw new Error("KHR_HTTP_" + r1.status);
      const d1 = await r1.json();
      usd_khr = d1.usd_khr;

      // 2) USD->CNY from open.er-api.com (no key)
      const controller2 = new AbortController();
      const t2 = setTimeout(() => controller2.abort(), 10000);
      const r2 = await fetch('https://open.er-api.com/v6/latest/USD', { cache: "no-store", signal: controller2.signal });
      clearTimeout(t2);
      if (!r2.ok) throw new Error("CNY_HTTP_" + r2.status);
      const d2 = await r2.json();
      usd_cny = d2 && d2.rates ? d2.rates.CNY : null;
      if (usd_cny == null) throw new Error("CNY_MISSING");

      metaEl.innerText =
        `Rates loaded: 1 USD = ${Math.round(usd_khr)} KHR | 1 USD = ${formatNumber(usd_cny, 4)} CNY (for reference only)`;

      renderQuickButtons();
      if (!document.getElementById("amount").value) {
        setDefaultAmountByFrom();
      }
      calculate(false);

    } catch (e) {
      metaEl.innerText = translations[currentLang].tapRetry;
      metaEl.style.cursor = "pointer";
      metaEl.onclick = () => loadRates();
      console.error(e);
    }
  }

  function swapFromTo(){
    const fromEl = document.getElementById("from");
    const toEl = document.getElementById("to");
    const tmp = fromEl.value;
    fromEl.value = toEl.value;
    toEl.value = tmp;

    // avoid From=To
    if (fromEl.value === toEl.value){
      toEl.value = (fromEl.value === "USD") ? "KHR" : "USD";
    }

    renderQuickButtons();
    setDefaultAmountByFrom();
    calculate(true, "swap_pair");
  }

  // Events
  document.getElementById("amount").addEventListener("input", () => calculate(true, "input"));

  document.getElementById("from").addEventListener("change", () => {
    // avoid From=To
    if (document.getElementById("from").value === document.getElementById("to").value){
      document.getElementById("to").value = (document.getElementById("from").value === "USD") ? "KHR" : "USD";
    }
    renderQuickButtons();
    setDefaultAmountByFrom();
    calculate(true, "change_from");
  });

  document.getElementById("to").addEventListener("change", () => {
    if (document.getElementById("from").value === document.getElementById("to").value){
      document.getElementById("from").value = (document.getElementById("to").value === "USD") ? "KHR" : "USD";
    }
    renderQuickButtons();
    calculate(true, "change_to");
  });

  document.getElementById("swap").addEventListener("click", swapFromTo);
  document.getElementById("copy").addEventListener("click", copyResult);

  // PWA
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js');
  }

  // Auto language detect
  const browserLang = navigator.language || navigator.userLanguage;
  if (browserLang && browserLang.toLowerCase().startsWith("km")) setLang("km");
  else setLang("en");

  // Default pair: USD -> KHR
  document.getElementById("from").value = "USD";
  document.getElementById("to").value = "KHR";

  // Default amount based on From
  setDefaultAmountByFrom();
  renderQuickButtons();

  // Init
  window.addEventListener("DOMContentLoaded", () => {
    loadRates();
  });
</script>

</body>
</html>
