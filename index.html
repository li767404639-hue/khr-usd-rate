<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>USD ⇄ KHR Converter</title>

<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3BT4GY2B36"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-3BT4GY2B36');
</script>

<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#ffffff">

<style>
body { font-family: system-ui, Arial; margin:20px; }
.card { max-width:520px; margin:auto; padding:20px; border:1px solid #eee; border-radius:12px; }
h1 { font-size:20px; }
.row { display:flex; gap:10px; margin:10px 0; }
input { flex:1; padding:10px; font-size:16px; }
button { padding:10px; }
.result { margin-top:15px; font-size:18px; }
.meta { color:#666; font-size:13px; margin-bottom:10px; }
.lang-switch { text-align:right; margin-bottom:10px; font-size:14px; cursor:pointer; }
.footer { text-align:center;margin-top:30px;font-size:12px; }
</style>
</head>

<body>
<div class="card">

<div class="lang-switch">
<span onclick="setLang('en')">EN</span> | 
<span onclick="setLang('km')">ខ្មែរ</span>
</div>

<h1 id="title">USD ⇄ KHR Converter</h1>
<div class="meta" id="meta">Loading official rate...</div>

<div class="row">
<input id="amount" type="number" placeholder="Enter amount" />
<button id="swap">USD → KHR</button>
</div>

<div class="result" id="result">Enter amount</div>

<div style="font-size:11px;color:#777;margin-top:6px;">
Source: Public daily reference rate. This tool does not provide financial services.
</div>

<div class="footer">
  <a href="/privacy.html">Privacy</a> |
  <a href="/terms.html">Terms</a> |
  <a href="/disclaimer.html">Disclaimer</a>
</div>

</div>

<script>

let usdKhr = null;
let mode = "USD2KHR";
let currentLang = "en";

const translations = {
en: {
title: "USD ⇄ KHR Converter",
enter: "Enter amount",
loading: "Loading official rate...",
swap1: "USD → KHR",
swap2: "KHR → USD"
},
km: {
title: "កម្មវិធីបម្លែង USD ⇄ KHR",
enter: "បញ្ចូលចំនួន",
loading: "កំពុងផ្ទុកអត្រាផ្លូវការ...",
swap1: "USD → KHR",
swap2: "KHR → USD"
}
};

function setLang(lang){
currentLang = lang;
document.getElementById("title").innerText = translations[lang].title;
document.getElementById("amount").placeholder = translations[lang].enter;
updateSwapText();
}

function updateSwapText(){
if(mode==="USD2KHR"){
document.getElementById("swap").innerText = translations[currentLang].swap1;
}else{
document.getElementById("swap").innerText = translations[currentLang].swap2;
}
}

async function loadRate() {
const metaEl = document.getElementById("meta");
try {
const controller = new AbortController();
const timer = setTimeout(() => controller.abort(), 10000);

const r = await fetch('/api/rate?ts=' + Date.now(), {
cache: "no-store",
signal: controller.signal
});

clearTimeout(timer);

if (!r.ok) throw new Error("HTTP_" + r.status);

const data = await r.json();
usdKhr = data.usd_khr;

metaEl.innerText =
"Official daily reference rate (" + data.date + "): 1 USD = " + usdKhr + " KHR (for reference only)";

} catch (e) {
metaEl.innerText = "Failed to load rate. Tap to retry.";
metaEl.style.cursor = "pointer";
metaEl.onclick = () => {
metaEl.innerText = "Loading official rate...";
loadRate();
};
}
}

function calculate() {
const amount = parseFloat(document.getElementById("amount").value);
if (!usdKhr || isNaN(amount)) {
document.getElementById("result").innerText = translations[currentLang].enter;
return;
}

if (mode === "USD2KHR") {
const khr = amount * usdKhr;
document.getElementById("result").innerText =
amount + " USD ≈ " + Math.round(khr) + " KHR";
} else {
const usd = amount / usdKhr;
document.getElementById("result").innerText =
amount + " KHR ≈ " + usd.toFixed(2) + " USD";
}

// GA 事件统计
gtag('event', 'calculate', {
  currency_mode: mode
});
}

document.getElementById("amount").addEventListener("input", calculate);

document.getElementById("swap").addEventListener("click", function() {
mode = mode === "USD2KHR" ? "KHR2USD" : "USD2KHR";
updateSwapText();
calculate();
});

if ('serviceWorker' in navigator) {
navigator.serviceWorker.register('/service-worker.js');
}

const browserLang = navigator.language || navigator.userLanguage;
if (browserLang && browserLang.startsWith("km")) {
setLang("km");
} else {
setLang("en");
}

window.addEventListener("DOMContentLoaded", () => {
loadRate();
});

</script>

</body>
</html>
