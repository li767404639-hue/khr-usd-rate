<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Currency Converter</title>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-3BT4GY2B36"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-3BT4GY2B36');
</script>

<style>
body{
  margin:0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
  background:#f4f7fb;
}

.container{
  max-width:680px;
  margin:40px auto;
  padding:20px;
}

.card{
  background:#ffffff;
  border-radius:16px;
  padding:24px;
  box-shadow:0 8px 30px rgba(0,0,0,0.06);
}

h1{
  font-size:20px;
  margin:0 0 10px;
  color:#1a1f36;
}

.meta{
  font-size:12px;
  color:#6b7280;
  margin-bottom:16px;
}

.result-big{
  font-size:32px;
  font-weight:600;
  color:#0f172a;
  margin:20px 0;
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}

label{
  font-size:12px;
  color:#6b7280;
}

select,input{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid #d1d5db;
  font-size:16px;
  margin-top:6px;
}

button{
  margin-top:14px;
  padding:12px;
  border:none;
  border-radius:12px;
  background:#1e3a8a;
  color:#fff;
  font-size:14px;
  cursor:pointer;
}

button:hover{
  background:#1e40af;
}

.quick{
  margin-top:12px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}

.quick button{
  background:#e5e7eb;
  color:#111827;
}

.quick button:hover{
  background:#d1d5db;
}

.copy-btn{
  margin-top:8px;
  background:#111827;
}

.footer{
  text-align:center;
  font-size:12px;
  color:#9ca3af;
  margin-top:20px;
}
</style>
</head>

<body>

<div class="container">
  <div class="card">

    <h1 id="title">Currency Converter</h1>
    <div class="meta" id="meta">Loading rates...</div>

    <div class="grid">
      <div>
        <label>From</label>
        <select id="from">
          <option value="USD">USD</option>
          <option value="KHR">KHR</option>
          <option value="CNY">RMB</option>
        </select>
      </div>
      <div>
        <label>To</label>
        <select id="to">
          <option value="KHR">KHR</option>
          <option value="USD">USD</option>
          <option value="CNY">RMB</option>
        </select>
      </div>
    </div>

    <div>
      <label>Amount</label>
      <input id="amount" type="number" placeholder="Enter amount">
    </div>

    <div class="quick" id="quickButtons"></div>

    <div class="result-big" id="result">
      50 USD ≈ 200,000 KHR
    </div>

    <button class="copy-btn" onclick="copyResult()">Copy Result</button>

    <div class="footer">
      For reference only. Not a financial service.
    </div>

  </div>
</div>

<script>
let usd_khr = null;
let usd_cny = null;

const QUICK = {
  USD:[50,75,120],
  KHR:[50000,100000,200000],
  CNY:[100,300,500]
};

function renderQuick(){
  const wrap=document.getElementById("quickButtons");
  wrap.innerHTML="";
  const from=document.getElementById("from").value;
  (QUICK[from]||[]).forEach(v=>{
    const b=document.createElement("button");
    b.innerText=v+" "+from;
    b.onclick=()=>{
      document.getElementById("amount").value=v;
      calculate(true,"quick");
    };
    wrap.appendChild(b);
  });
}

function getRate(from,to){
  if(from===to) return 1;
  if(!usd_khr||!usd_cny) return null;

  if(from==="USD"&&to==="KHR") return usd_khr;
  if(from==="USD"&&to==="CNY") return usd_cny;
  if(from==="KHR"&&to==="USD") return 1/usd_khr;
  if(from==="CNY"&&to==="USD") return 1/usd_cny;
  if(from==="KHR"&&to==="CNY") return (1/usd_khr)*usd_cny;
  if(from==="CNY"&&to==="KHR") return (1/usd_cny)*usd_khr;
}

function calculate(track=true,source="input"){
  const from=document.getElementById("from").value;
  const to=document.getElementById("to").value;
  const amt=parseFloat(document.getElementById("amount").value);

  if(isNaN(amt)) return;

  const rate=getRate(from,to);
  if(!rate) return;

  const val=amt*rate;
  document.getElementById("result").innerText=
    amt.toLocaleString()+" "+from+" ≈ "+
    val.toLocaleString(undefined,{maximumFractionDigits:2})+" "+to;

  if(track){
    gtag('event','calculate',{from_currency:from,to_currency:to,source:source});
  }
}

async function loadRates(){
  const r1=await fetch('/api/rate');
  const d1=await r1.json();
  usd_khr=d1.usd_khr;

  const r2=await fetch('https://open.er-api.com/v6/latest/USD');
  const d2=await r2.json();
  usd_cny=d2.rates.CNY;

  document.getElementById("meta").innerText=
    "1 USD = "+usd_khr+" KHR | 1 USD = "+usd_cny.toFixed(4)+" CNY";

  document.getElementById("amount").value=50;
  renderQuick();
  calculate(false);
}

function copyResult(){
  const text=document.getElementById("result").innerText;
  navigator.clipboard.writeText(text);
  gtag('event','copy_result');
}

document.getElementById("from").addEventListener("change",()=>{renderQuick();calculate();});
document.getElementById("to").addEventListener("change",()=>calculate());
document.getElementById("amount").addEventListener("input",()=>calculate());

loadRates();
</script>

</body>
</html>
